#ifdef __cplusplus
extern "C" {
#endif

#include <assert.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <ctype.h>
#include <openssl/ossl_typ.h>
#include <openssl/conf.h>
#include <openssl/opensslv.h>
#include <openssl/objects.h>
#include <openssl/err.h>
#include <openssl/crypto.h>
#include <openssl/hmac.h>
#include <openssl/opensslconf.h>
#include <openssl/stack.h>
#include <openssl/safestack.h>
#include <openssl/bio.h>
#include <openssl/bn.h>
#include <openssl/objects.h>
#include <openssl/rsa.h>
#include <openssl/evp.h>
#include <openssl/sha.h>
#include <openssl/pkcs7.h>
#include <openssl/dsa.h>
#include <openssl/ec.h>			
#include <openssl/x509.h>
#include <openssl/pem.h>
#include <openssl/pem2.h>


unsigned char g_aucPrvData[]=
{
	0x30,0x82,0x04,0xa2,0x02,0x01,0x00,0x02,0x82,0x01,0x01,0x00,0xc2,0x90,0x0f,0x02,0x12,0x6c,0x8c,0x3e,0x8c,0xb5,0x3c,0x56,0x2d,0x51,0x19,0xf9,0xad,0xbd,0x32,0x9e,
	0xf2,0x76,0xc6,0x17,0xdf,0xe5,0x9c,0x1a,0xcb,0xd3,0xb6,0xde,0x0d,0xd2,0xe6,0x4b,0x7b,0xf5,0xe6,0xd8,0x66,0x0e,0xda,0x5f,0x85,0x8e,0x37,0x25,0x00,0x47,0x58,0x99, 0xa7,0xcd,0xa2,0x10,0x92,0xcb,0x9a,0x67,0xc6,0x1c,0x00,0xe7,0x15,0xc9,0x0c,0xbf,0x83,0x28,0x7c,0xe9,0x66,0x79,0xf3,0xcd,0xb4,0x7f,0x1f,0x9b,0x1e,0x04,0x7e,0xad,
	0x43,0xd1,0x17,0x0c,0xb4,0x2c,0xc2,0xe8,0x7f,0x6c,0xf5,0x57,0x7a,0xfa,0xe4,0x28,0xe8,0x1c,0x84,0xab,0x15,0xde,0x0f,0x06,0xae,0xd7,0x69,0xd4,0xde,0xe2,0x6c,0xef,
	0x04,0xb7,0x83,0x10,0xb4,0x8d,0xd2,0x99,0xd7,0x01,0xf8,0x46,0xe7,0x84,0x33,0xfe,0x9c,0x4f,0x20,0x0a,0xc5,0x49,0x6a,0x63,0xf3,0x05,0x30,0xdf,0x69,0x5b,0xe8,0x3c,
	0xc3,0x0b,0x79,0xb5,0x99,0x18,0x99,0x24,0x32,0x87,0x2d,0x4a,0x6f,0xc6,0x94,0x86,0xdd,0x19,0xf0,0xcf,0x26,0xd0,0x7e,0x50,0x0e,0xcb,0x7b,0x23,0x7a,0x1c,0xef,0x07,
	0x0b,0x5e,0x2d,0xd4,0xf1,0x46,0xb9,0xed,0x42,0x92,0x98,0xaa,0x9f,0xcd,0xf6,0xef,0x97,0x6a,0x6a,0x01,0xae,0x86,0xf9,0xfd,0x46,0x97,0xe0,0x96,0x88,0x02,0xfc,0x61,
	0x48,0xf5,0x7b,0x30,0xa8,0x71,0x3e,0xc4,0xd3,0x6b,0x11,0x2c,0x58,0xa2,0xdf,0xa3,0xc2,0x6d,0xfa,0xc7,0xad,0x68,0xf0,0xa9,0xee,0xac,0x00,0xec,0xeb,0xb0,0xe7,0xfe,
	0x05,0x5c,0x56,0xba,0xe8,0xda,0x12,0x5d,0x29,0x8c,0xb4,0x01,0x02,0x03,0x01,0x00,0x01,0x02,0x82,0x01,0x00,0x61,0x64,0x87,0x7e,0xbc,0x06,0x46,0x35,0xd1,0x6d,0xaf,
	0xa4,0x5b,0xce,0xeb,0x37,0xc6,0xb6,0x9c,0xae,0x60,0x25,0x00,0x88,0x56,0xf5,0xb3,0x2c,0xde,0xb7,0x3e,0x24,0xed,0xba,0x92,0xb9,0x5a,0x75,0xff,0x76,0x77,0xb0,0x1b,
	0xb4,0x11,0x40,0xdd,0x6d,0xd2,0x33,0xe4,0xb0,0x16,0x05,0xa3,0x88,0xb4,0x52,0xe3,0x19,0xeb,0x5b,0x7d,0x40,0x2f,0xf1,0x92,0x46,0x13,0xbb,0xa2,0xbb,0x9b,0x26,0x94,
	0xda,0x75,0xed,0xe4,0xbe,0x5b,0x4a,0x58,0xb7,0x16,0xe9,0x85,0xa6,0x40,0x52,0xdf,0xc6,0x4e,0x73,0x16,0x65,0x12,0x14,0xa1,0x3d,0xb0,0xe3,0x05,0xae,0x36,0xa6,0x0f,
	0xd3,0x82,0x96,0x26,0x4d,0xfe,0xbc,0x4d,0x57,0x60,0x7f,0x14,0x46,0xba,0x7a,0xfb,0xdf,0x32,0x77,0xb3,0xf5,0xba,0xd8,0xbc,0xb2,0x3e,0xc5,0xd3,0x05,0x32,0x52,0x7d,
	0x63,0xd6,0xee,0xc7,0xb5,0xd9,0x2d,0x37,0x79,0x72,0x38,0x1a,0x11,0x0f,0xb5,0x39,0x6b,0x60,0x03,0x5f,0x45,0x45,0x28,0x67,0x85,0x03,0x53,0x67,0xf1,0xa5,0xd9,0xd8,
	0x43,0x2d,0x7e,0xb2,0xe1,0xed,0x63,0x07,0xac,0xf7,0x72,0xf9,0xdd,0x7a,0xf2,0x7e,0xe9,0x27,0x0a,0x47,0x02,0xf1,0x29,0x76,0x7a,0x7d,0x52,0xa9,0xd1,0x42,0x5d,0x0a,
	0x64,0xc7,0x24,0x5e,0xc0,0x95,0x87,0x87,0x5a,0x42,0x24,0xa2,0xaa,0x2e,0x0b,0xc0,0x2e,0x8b,0x16,0x43,0xf7,0xde,0x29,0xde,0xa8,0xc9,0xba,0x1e,0xeb,0x56,0xf9,0xce,
	0x7e,0xea,0xff,0xe7,0xf0,0x1c,0x22,0x34,0xbd,0xc2,0xd5,0x25,0xb9,0x2c,0x85,0xfc,0x06,0x4b,0x07,0x62,0x81,0x02,0x81,0x81,0x00,0xe3,0x78,0x6b,0x6e,0xc5,0xb1,0x35,
	0x6f,0x92,0x74,0xc9,0x87,0xa5,0x7a,0xf3,0x85,0xc1,0xed,0xd7,0xef,0x26,0x45,0xe8,0x23,0xe9,0x2a,0x40,0x57,0x3e,0x1d,0x63,0x9b,0xc3,0x64,0x20,0x30,0x98,0x7a,0x00, 0x29,0x74,0x93,0x68,0x73,0xf0,0x44,0x60,0x49,0xc2,0x19,0x7e,0x15,0x7e,0x24,0xf0,0xfe,0xd9,0x20,0x22,0xe1,0x56,0x0e,0x7c,0x80,0xb0,0x3b,0x52,0x66,0xe5,0xc4,0xe7, 0x78,0x58,0x87,0xaa,0x9d,0xfd,0x2c,0xb3,0x0e,0x31,0x12,0x14,0xc5,0xed,0x14,0x14,0xb1,0xf7,0x92,0x11,0x77,0xd4,0x3a,0xa2,0xff,0x40,0x0e,0xd4,0xd9,0x04,0xc4,0xb9,
	0xce,0x60,0x42,0x76,0xcd,0xf1,0x61,0xba,0xa4,0xe9,0x64,0x68,0x79,0xaa,0xc7,0xde,0x76,0x19,0x4d,0x65,0x7e,0x14,0x11,0x9e,0x09,0x02,0x81,0x81,0x00,0xda,0xf7,0x0b,
	0xa1,0xf6,0x4c,0x5f,0x3a,0x88,0xd7,0xb8,0x84,0x9e,0xec,0xd6,0xca,0xd8,0x0d,0x7f,0xab,0x39,0x97,0xea,0x8c,0xf1,0xca,0x39,0x45,0x1d,0xdf,0xfc,0x06,0x71,0x78,0x98,
	0x68,0xb9,0x74,0x6b,0x07,0x41,0xaf,0x83,0xa9,0x7a,0x0c,0x2e,0x96,0x9b,0x66,0x05,0x8d,0x70,0xb1,0xd2,0x68,0xc6,0xfa,0xbc,0x59,0x8d,0x91,0x70,0x1a,0x93,0xc9,0x15, 0x17,0x5f,0xaf,0x89,0x47,0x7d,0x2f,0x13,0xad,0x5f,0x2a,0x6c,0xf7,0x99,0x58,0xf6,0xf3,0x3a,0xcd,0x6e,0xce,0x97,0xba,0xc7,0xa6,0x96,0x0e,0x06,0x47,0xac,0x6c,0xac, 0xd5,0x51,0xbf,0x79,0x15,0xb8,0xec,0x30,0x38,0x66,0xdd,0x48,0xc3,0x3d,0x92,0x45,0x0d,0xc6,0xa2,0x92,0xf8,0x3d,0xc9,0xa1,0xad,0xd9,0xfd,0x64,0x39,0x02,0x81,0x80, 0x23,0xaf,0xfe,0xda,0xf0,0x35,0x2f,0x37,0x03,0xf9,0x42,0xac,0xff,0x6f,0x5c,0xc9,0x7d,0x75,0x7d,0x4d,0x4d,0xe9,0xe5,0xd3,0xcc,0x7f,0x0e,0x7d,0x21,0x87,0xa6,0xdb,
	0x07,0x3a,0xac,0x3a,0x33,0x91,0xe0,0x78,0xa0,0x8b,0x87,0xf5,0xb8,0x9a,0x61,0xa8,0xf0,0xc4,0xe3,0x1d,0x28,0x1f,0x4f,0x98,0x0c,0x24,0x98,0x94,0x55,0xd6,0x0b,0xfe,
	0x7c,0xa7,0xb1,0xf3,0xe6,0xd4,0x8f,0xa4,0x37,0xef,0x80,0xfb,0x2c,0x7f,0x58,0xd0,0x3f,0x2e,0xa1,0x07,0xb4,0x7c,0x54,0x0a,0xdf,0xd6,0x90,0xdb,0x05,0xf6,0xf5,0x1f,
	0xaa,0xc3,0x28,0xed,0xab,0x6b,0xd9,0xe2,0xe1,0x03,0x4c,0x74,0x5f,0x0c,0x80,0x25,0xe3,0x60,0x17,0x6c,0x0f,0x39,0x30,0x53,0xc3,0x00,0x7b,0x8d,0xde,0x44,0x2d,0x51,
	0x02,0x81,0x80,0x61,0xf3,0x63,0x93,0xc7,0x3f,0x30,0xd6,0x59,0x82,0xce,0xbb,0x1c,0xf0,0xeb,0xc0,0xff,0xd7,0x42,0x06,0x51,0x94,0x40,0xcb,0x5e,0x1a,0x4d,0x76,0x3a,
	0xc0,0x08,0xd8,0xc5,0x07,0xe2,0x7d,0xee,0x80,0x42,0xa4,0x93,0x60,0xb5,0x70,0x29,0xf5,0xab,0x1d,0x9a,0x54,0x90,0x25,0x4e,0x85,0x6d,0x8f,0x8b,0x7b,0x7c,0xa8,0x3e,
	0xe9,0x11,0x92,0x02,0x0c,0x50,0xd0,0x0c,0xf0,0xd4,0x63,0x53,0x7f,0xac,0xb8,0xc0,0xba,0x94,0xd6,0x4a,0x15,0xff,0x1a,0x9d,0x72,0x6a,0xa0,0x26,0x45,0xda,0xac,0x0d,
	0xb2,0x26,0x63,0x07,0xa1,0xf1,0xca,0xd7,0x6f,0xe4,0xf5,0xaf,0xac,0x90,0x81,0x9a,0x9a,0x60,0xc3,0x5e,0x16,0xc1,0xa7,0x40,0xf5,0x56,0xf3,0x8f,0x88,0x54,0x38,0x16,
	0x2d,0x01,0x19,0x02,0x81,0x80,0x36,0xcc,0xfe,0x70,0x6d,0x64,0xb8,0xdc,0xdf,0x31,0xf6,0x7e,0x91,0xb3,0x46,0x26,0xce,0x81,0x9e,0x88,0xe6,0x4d,0xae,0x9f,0xed,0x4d,
	0xc8,0x71,0xe9,0x47,0x5c,0x93,0xa9,0xaa,0x84,0x65,0x70,0xa2,0xd6,0xf5,0x54,0x74,0x4f,0x79,0x26,0x85,0x0f,0xce,0xaa,0x24,0x19,0x09,0x60,0xe2,0x35,0x62,0xcb,0xb0,
	0x3e,0x17,0xba,0x1c,0xcb,0x68,0xce,0x43,0x6d,0x43,0x93,0xfc,0x66,0xa0,0xcf,0x1c,0x4c,0x81,0xe6,0xd6,0xc7,0x6d,0xb3,0xad,0x74,0x35,0x61,0x4e,0x89,0x0f,0x80,0x6e,
	0x57,0x0d,0x63,0x07,0x7b,0x2c,0x14,0x13,0xfd,0x62,0x97,0x62,0xa0,0x00,0x68,0x22,0xf0,0xc6,0xe4,0x27,0xc0,0x69,0xf4,0x02,0xe6,0xc2,0xca,0x1a,0x92,0xf9,0x16,0xe0,
	0xa4,0x20,0x96,0x08,0xaf,0x0a
};

unsigned char g_aucPubData[] =
{
	0x30,0x82,0x01,0x22,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,0x01,0x01,0x05,0x00,0x03,0x82,0x01,0x0f,0x00,0x30,0x82,0x01,0x0a,0x02,0x82,0x01,0x01,
	0x00,0xc2,0x90,0x0f,0x02,0x12,0x6c,0x8c,0x3e,0x8c,0xb5,0x3c,0x56,0x2d,0x51,0x19,0xf9,0xad,0xbd,0x32,0x9e,0xf2,0x76,0xc6,0x17,0xdf,0xe5,0x9c,0x1a,0xcb,0xd3,0xb6,
	0xde,0x0d,0xd2,0xe6,0x4b,0x7b,0xf5,0xe6,0xd8,0x66,0x0e,0xda,0x5f,0x85,0x8e,0x37,0x25,0x00,0x47,0x58,0x99,0xa7,0xcd,0xa2,0x10,0x92,0xcb,0x9a,0x67,0xc6,0x1c,0x00,
	0xe7,0x15,0xc9,0x0c,0xbf,0x83,0x28,0x7c,0xe9,0x66,0x79,0xf3,0xcd,0xb4,0x7f,0x1f,0x9b,0x1e,0x04,0x7e,0xad,0x43,0xd1,0x17,0x0c,0xb4,0x2c,0xc2,0xe8,0x7f,0x6c,0xf5,
	0x57,0x7a,0xfa,0xe4,0x28,0xe8,0x1c,0x84,0xab,0x15,0xde,0x0f,0x06,0xae,0xd7,0x69,0xd4,0xde,0xe2,0x6c,0xef,0x04,0xb7,0x83,0x10,0xb4,0x8d,0xd2,0x99,0xd7,0x01,0xf8,
	0x46,0xe7,0x84,0x33,0xfe,0x9c,0x4f,0x20,0x0a,0xc5,0x49,0x6a,0x63,0xf3,0x05,0x30,0xdf,0x69,0x5b,0xe8,0x3c,0xc3,0x0b,0x79,0xb5,0x99,0x18,0x99,0x24,0x32,0x87,0x2d,
	0x4a,0x6f,0xc6,0x94,0x86,0xdd,0x19,0xf0,0xcf,0x26,0xd0,0x7e,0x50,0x0e,0xcb,0x7b,0x23,0x7a,0x1c,0xef,0x07,0x0b,0x5e,0x2d,0xd4,0xf1,0x46,0xb9,0xed,0x42,0x92,0x98,
	0xaa,0x9f,0xcd,0xf6,0xef,0x97,0x6a,0x6a,0x01,0xae,0x86,0xf9,0xfd,0x46,0x97,0xe0,0x96,0x88,0x02,0xfc,0x61,0x48,0xf5,0x7b,0x30,0xa8,0x71,0x3e,0xc4,0xd3,0x6b,0x11,
	0x2c,0x58,0xa2,0xdf,0xa3,0xc2,0x6d,0xfa,0xc7,0xad,0x68,0xf0,0xa9,0xee,0xac,0x00,0xec,0xeb,0xb0,0xe7,0xfe,0x05,0x5c,0x56,0xba,0xe8,0xda,0x12,0x5d,0x29,0x8c,0xb4,
	0x01,0x02,0x03,0x01,0x00,0x01
};

unsigned char g_aucDecData[] = 
{
	0xbb,0x43,0x0b,0x4d,0x0f,0xb0,0x59,0x20,0x57,0xaf,0xb8,0xf4,0xad,0x5a,0xd6,0x39,0xbe,0x8c,0x82,0xcc,0x16,0x47,0x85,0x9f,0x97,0x9e,0x6c,0xf2,0xf8,0x5b,0xd0,0x11,
	0xd5,0x36,0x26,0x88,0xf8,0x4a,0xc0,0x75,0x3c,0x59,0x40,0xd7,0xe8,0xdd,0xc2,0x07,0xc7,0x98,0xb5,0xfa,0x90,0x7a,0x0a,0xd5,0xab,0x29,0x82,0xd9,0x6b,0xfe,0xda,0x7b,
	0x90,0x65,0xff,0xb3,0x22,0x90,0x20,0x3c,0x4c,0x34,0x51,0xc0,0x86,0x09,0x20,0x13,0x74,0x11,0xff,0x95,0xd0,0xb6,0x00,0x7a,0x08,0xbf,0x5d,0x23,0xe3,0x12,0xef,0xcb,
	0xa6,0x5c,0xd9,0x31,0x88,0xb0,0x75,0x73,0x7b,0x12,0x0c,0x53,0xa2,0xa0,0xde,0xa9,0xa1,0x6e,0x18,0xed,0xd5,0xdd,0xf4,0x50,0x8d,0xcd,0x8e,0x91,0xc6,0x98,0x5f,0x28,
	0x05,0xee,0xfb,0x66,0x4a,0xe4,0x32,0x61,0x65,0x6b,0xce,0x70,0x85,0xc8,0xe4,0x18,0x2d,0x55,0x71,0x01,0x8e,0xf2,0x9d,0xa4,0xa3,0x4c,0x37,0xef,0x35,0xf0,0x9b,0xc6,
	0x1c,0x39,0x21,0x9b,0x2e,0xad,0xc1,0x82,0xfa,0xd0,0x4b,0x6d,0x28,0x5c,0x9d,0xde,0x7f,0x1a,0x7c,0xff,0x82,0x89,0xff,0xfc,0xfc,0x5c,0x60,0x22,0x21,0xcf,0x84,0x9f,
	0xd6,0x59,0x4b,0xba,0xb2,0x5a,0x8b,0xd6,0x5a,0x41,0x61,0x70,0x38,0x1c,0xc5,0x82,0x1e,0x29,0x99,0x63,0x88,0xe1,0xd2,0x47,0x5d,0x33,0x87,0xa2,0x09,0xe1,0x46,0xda,
	0xf0,0x50,0x77,0x3e,0x26,0xf8,0x56,0xe2,0xd3,0xc3,0xe9,0x90,0x05,0xc4,0x83,0xe1,0x80,0x09,0xf5,0x19,0xe5,0x08,0x43,0x64,0xb2,0xab,0x07,0x49,0x59,0x30,0x54,0x89
};

unsigned char g_aucEncData_nopad[] = 
{
	0x00,0x02,0x04,0xdd,0x84,0x3f,0xa0,0x74,0xff,0x97,0xc4,0xee,0x49,0x58,0xee,0x97,0x1a,0x13,0x6e,0x79,0xe1,0x2f,0xb5,0x98,0x10,0xb3,0x22,0xd0,0x83,0x43,0xde,0x20,
	0xd2,0x30,0x01,0x3f,0xb5,0x96,0x18,0xbd,0x4f,0x90,0x29,0x07,0xed,0x20,0xcc,0xd8,0x67,0xac,0x8b,0xdb,0x0b,0x23,0xed,0x84,0x0c,0x0b,0x05,0x1f,0x12,0x5e,0x99,0x70,
	0xdd,0xc3,0x2a,0xf2,0x40,0xa9,0x58,0x95,0x66,0x4c,0x6a,0x38,0x2f,0xa7,0x0c,0x9f,0xb2,0xee,0xc8,0xb5,0x04,0x34,0xff,0x24,0x65,0xdd,0xd8,0x71,0xc6,0xd3,0x8d,0x73,
	0x2b,0x72,0x07,0xbb,0x41,0x04,0x82,0x02,0x63,0x49,0xbb,0xed,0x60,0xfb,0x7a,0xda,0x8d,0x43,0x25,0xcd,0x3e,0x44,0xef,0x0e,0xeb,0xa9,0x29,0x60,0xe7,0xdc,0xd9,0x02,
	0x77,0x84,0xb5,0x4f,0x43,0xa0,0x69,0x73,0xc2,0x01,0xa4,0x4d,0x10,0xe9,0xea,0x8a,0xf2,0x0b,0xba,0x50,0x76,0x03,0x86,0xb5,0x06,0x8e,0xa5,0x99,0x76,0xdb,0xc6,0xe3,
	0x59,0x53,0x60,0xf7,0x37,0x2d,0x8c,0xa5,0xfd,0xb6,0xb8,0xdf,0x42,0x38,0xe9,0xb1,0x7f,0x8e,0xaf,0xcf,0x9b,0x52,0xdb,0xd4,0x21,0x6b,0x2f,0xf6,0xca,0xa4,0x22,0x1a,
	0x9f,0x42,0xe6,0x0f,0x39,0x39,0xfe,0xd3,0x23,0xe2,0x01,0xfe,0xaf,0x16,0x15,0x00,0x03,0x03,0x7b,0xc1,0x54,0x4a,0xfe,0x02,0x01,0xdc,0x55,0xed,0xcf,0xeb,0xb6,0xd6,
	0x73,0xa2,0x0d,0x45,0x4b,0x89,0xbb,0xb3,0x89,0x31,0xdf,0x9e,0x92,0x68,0x09,0xc7,0xe0,0xb5,0x48,0xe1,0x9d,0xc5,0x4c,0xa1,0x4a,0x93,0x7c,0x45,0x60,0x3c,0x1e,0x38
};
/**
 * 1. 签名: NID_mdc2(PKCS1_PADDING)/X931_PADDING/PKCS1_PADDING/PSS_PADDING
 *    prv_enc: PKCS1_PADDING/X931_PADDING/NO_PADDING
 * 2. 验签：PKCS1_PADDING/X931_PADDING/PSS_PADDING
 * 	  pub_dec: PKCS1_PADDING/X931_PADDING/NO_PADDING
 * 3. 加密：OAEP_PADDING(因为pub_enc中该模式不使用label)
 * 	  pub_enc: PKCS1_PADDING/OAEP_PADDING/SSLV23_PADDING/NO_PADDING
 * 4. 解密：OAEP_PADDING
 * 	  prv_dec: PKCS1_PADDING/OAEP_PADDING/SSLV23_PADDING/NO_PADDING
 */
int rsa_test_check_padding(EVP_PKEY_CTX *ctx,
						   int iPrvEnc,
						   unsigned char *pucOut,
						   int uiOutLen,
						   unsigned char *pucFrom,
						   int iFromLen,
						   int iNum)
{
	int iPadding;
	EVP_MD *pstMd = NULL;
	EVP_MD *pstMgfMd = NULL;

	EVP_PKEY_CTX_get_rsa_padding(ctx, &iPadding);
	EVP_PKEY_CTX_get_signature_md(ctx, &pstMd);
	int iRet = 0;
	unsigned char *pucTmpBuf = NULL;
	int saltlen = 0;
	EVP_PKEY *pkey = NULL;
	RSA *rsa = NULL;

	if ((RSA_PKCS1_PSS_PADDING  == iPadding) ||
	    (RSA_PKCS1_OAEP_PADDING == iPadding))
	{
		EVP_PKEY_CTX_get_rsa_mgf1_md(ctx, &pstMgfMd);	
	}

	switch(iPadding)
	{
		case RSA_PKCS1_PADDING:
		{
			if (1 == iPrvEnc)
			{	
				iRet = RSA_padding_check_PKCS1_type_1(pucOut, uiOutLen, pucFrom, iFromLen, iNum);			
			}
			else
			{
				iRet = RSA_padding_check_PKCS1_type_2(pucOut, uiOutLen, pucFrom, iFromLen, iNum);	
			}
			break;
		}
		case RSA_X931_PADDING:
		{
			iRet = RSA_padding_check_X931(pucOut, uiOutLen, pucFrom, iFromLen, iNum);
			break;
		}
		case RSA_PKCS1_OAEP_PADDING:
		{
			iRet = RSA_padding_check_PKCS1_OAEP(pucOut, uiOutLen, pucFrom, iFromLen, iNum, NULL, 0);
			break;
		}
		case RSA_PKCS1_PSS_PADDING:
		{
			pkey = EVP_PKEY_CTX_get0_pkey(ctx);
			pucTmpBuf = OPENSSL_malloc(EVP_PKEY_size(pkey));
			EVP_PKEY_CTX_get_rsa_pss_saltlen(ctx, &saltlen);
			rsa = EVP_PKEY_get0_RSA(pkey);
			iRet = RSA_verify_PKCS1_PSS_mgf1(rsa, pucFrom, pstMd, pstMgfMd, pucTmpBuf, saltlen);

			OPENSSL_free(pucTmpBuf);
	
			break;
		}
		case RSA_NO_PADDING:
		{
			memcpy(pucOut, pucFrom, iFromLen);
			iRet = iFromLen;
			break;
		}
		default:
		{
			assert(0);
			return;
			break;
		}	
	}

	
	return iRet;
}


int rsa_test_padding(EVP_PKEY_CTX *ctx,
					 int iPrvEnc,
					 unsigned char *pucData,
					 unsigned int uiDataLen,
					 int *piOutLen,
					 unsigned char *pucOut)
{		
	int iPadding;
	EVP_MD *pstMd = NULL;
	EVP_MD *pstMgfMd = NULL;

	EVP_PKEY_CTX_get_rsa_padding(ctx, &iPadding);
	EVP_PKEY_CTX_get_signature_md(ctx, &pstMd);
	int iRet = 0;
	EVP_PKEY *pkey = EVP_PKEY_CTX_get0_pkey(ctx);
	RSA *rsa = EVP_PKEY_get0_RSA(pkey);
	int saltlen = 0;
	int num = BN_num_bytes(RSA_get0_n(rsa));

	if ((RSA_PKCS1_PSS_PADDING  == iPadding) ||
	    (RSA_PKCS1_OAEP_PADDING == iPadding))
	{
		EVP_PKEY_CTX_get_rsa_mgf1_md(ctx, &pstMgfMd);	
	}

	switch(iPadding)
	{
		case RSA_PKCS1_PADDING:
		{
			if (1 == iPrvEnc)
			{	
				iRet = RSA_padding_add_PKCS1_type_1(pucOut, num, pucData, uiDataLen);
			}
			else
			{
				iRet = RSA_padding_add_PKCS1_type_2(pucOut, num, pucData, uiDataLen);
			}
			break;
		}
		case RSA_X931_PADDING:
		{
			iRet = RSA_padding_add_X931(pucOut, num, pucData, uiDataLen);	
			break;
		}
		case RSA_PKCS1_PSS_PADDING:
		{
			EVP_PKEY_CTX_get_rsa_pss_saltlen(ctx, &saltlen);
	
			iRet = RSA_padding_add_PKCS1_PSS_mgf1(rsa, pucOut, pucData, pstMd, pstMgfMd, saltlen);
			break;
		}
		case RSA_PKCS1_OAEP_PADDING:
		{
			unsigned char *label = NULL;
			int labellen = 0;
			labellen = EVP_PKEY_CTX_get0_rsa_oaep_label(ctx, &label);
			RSA_padding_add_PKCS1_OAEP_mgf1(pucOut, EVP_PKEY_size(pkey), pucData, uiDataLen, label, labellen, pstMd, pstMgfMd);
			
			break;
		}
		case RSA_NO_PADDING:
		{
			iRet = RSA_padding_add_none(pucOut, num, pucData, uiDataLen);
			break;
		}
		case RSA_SSLV23_PADDING: default:
		{
			assert(0);
			return;
			break;
		}
	}	

	if (iRet == 1)
	{
		*piOutLen = num;
	}

	return iRet;
}

EVP_PKEY *rsa_get_prvkey()
{
	BIO *bio_in = NULL;
	EVP_PKEY *pkey = NULL;

	bio_in = BIO_new(BIO_s_mem());
	BIO_write(bio_in, g_aucPrvData, sizeof(g_aucPrvData));
	pkey = d2i_PrivateKey_bio(bio_in, NULL);
	return pkey;
}

EVP_PKEY *rsa_get_pubkey()
{
	BIO *bio_in = NULL;
	EVP_PKEY *pkey = NULL;
	
	bio_in = BIO_new(BIO_s_mem());
	BIO_write(bio_in, g_aucPubData, sizeof(g_aucPubData));
	pkey = d2i_PUBKEY_bio(bio_in, NULL);
	return pkey;
}

void rsa_test_decrypt(unsigned char *pucPlain, 
					  unsigned long *pulPlainlen,
					  unsigned char *pucCipher,
					  unsigned long ulCipherlen)
{
	EVP_PKEY_CTX *ctx = NULL;
	EVP_PKEY *pkey = rsa_get_prvkey();

	printf("====================rsa_test_decrypt=========================\r\n");
	printf("-------cipher data---------\r\n");
	BIO_dump_fp(stdout, pucCipher, ulCipherlen);
	
	ctx = EVP_PKEY_CTX_new(pkey, NULL);
	if (ctx == NULL
		|| EVP_PKEY_decrypt_init(ctx) <=0
		|| EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_NO_PADDING) <=0
		|| EVP_PKEY_decrypt(ctx, pucPlain, pulPlainlen, pucCipher, ulCipherlen) <= 0)
	{
		assert(0);	
		return;
	}
	else
	{
		printf("-------plaint data---------\r\n");
		BIO_dump_fp(stdout, pucPlain, *pulPlainlen);
	}

	return ;
}

void rsa_test_encrypt(unsigned char *pucPlain,
					  unsigned long ulPlainlen,
					  unsigned char *pucCipher,
					  unsigned long *pulCipherlen)
{
	EVP_PKEY_CTX *ctx = NULL;
	EVP_PKEY *pkey = rsa_get_pubkey();
	
	printf("=============================rsa_test_encrypt==============================\r\n");
	printf("-------plain data---------\r\n");
	BIO_dump_fp(stdout, pucPlain, ulPlainlen);
	
	ctx = EVP_PKEY_CTX_new(pkey, NULL);
	if (ctx == NULL 
		|| EVP_PKEY_encrypt_init(ctx) <= 0
		|| EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_NO_PADDING) <= 0
		|| EVP_PKEY_encrypt(ctx, pucCipher, pulCipherlen, pucPlain, ulPlainlen) <=0 )
	{
		assert(0);
	}
	else
	{
		printf("-------cipher data---------\r\n");
		BIO_dump_fp(stdout, pucCipher, *pulCipherlen);
	}

	return ;

}
unsigned char g_aucMdData[] = 
{
	0x67,0x03,0xb6,0x17,0x19,0xe3,0xda,0xb9,0x84,0x63,0x1d,0x02,0xca,0xd5,0xdc,0xc5,
	0x2e,0xce,0xae,0xa9,0x3d,0x0a,0x44,0x48,0x39,0x83,0x25,0x67,0x24,0x69,0xfd,0x1a
};

unsigned char g_aucSigData[]=
{
	0x58,0xf4,0x6e,0x73,0x04,0x70,0x1c,0x66,0x90,0x74,0xfd,0xed,0xff,0x67,0x8e,0x1b,0xaa,0x35,0x80,0xa9,0xa7,0x53,0x6e,0xa4,0xa1,0x54,0x9a,0x4e,0xca,0xfd,0x29,0xd8,
	0xe3,0x4e,0xe1,0xa7,0x48,0x84,0x2d,0x6e,0x94,0x67,0x7e,0xa5,0xe4,0xff,0xb7,0x53,0xe0,0x1b,0x4a,0xd3,0xb2,0x25,0x43,0x8d,0xd6,0xf1,0x69,0x72,0x24,0x69,0x28,0x1b,
	0x78,0xb3,0x8a,0x39,0xc2,0xea,0xec,0xfd,0xae,0x2e,0x3b,0x1b,0x81,0xd2,0x9b,0x81,0x94,0xf3,0x71,0x07,0xbe,0xe2,0xc3,0x84,0x11,0x80,0xa8,0x26,0xd7,0x28,0xee,0x85,
	0x91,0x01,0x15,0xde,0x93,0xd9,0x81,0xc5,0x03,0x3e,0x9c,0x76,0x18,0x2e,0x9f,0x85,0x52,0x5b,0x7c,0xe1,0xfe,0x06,0xb1,0x76,0xfd,0xbc,0xc9,0xaa,0x0b,0xda,0x97,0xe9,
	0x5b,0x9b,0x4d,0x74,0x83,0x71,0xb8,0x53,0xb2,0x73,0x05,0x75,0x6e,0xc9,0x03,0x1c,0x68,0xf4,0x85,0x93,0x6d,0xd0,0xbf,0x3c,0x27,0x89,0x60,0x69,0xe1,0x2d,0xe1,0xa7,
	0xa2,0x18,0x1c,0xf6,0xbc,0xea,0xca,0x02,0x9a,0x9a,0xda,0xad,0xe5,0xbb,0x99,0xec,0x1b,0xff,0xba,0x76,0xce,0xa8,0x48,0x8d,0xf1,0xe8,0xba,0x51,0x57,0x19,0xbb,0x84,
	0x47,0x69,0xa2,0x0b,0x1b,0xdd,0x57,0x70,0xe3,0xd0,0x4d,0x42,0x5a,0xd0,0xb6,0xa1,0x76,0xfd,0xf3,0x1b,0x31,0x6d,0x50,0x03,0x98,0x37,0x31,0x22,0x3c,0x3e,0xd8,0xf4,
	0xf4,0x2b,0x50,0xb2,0xea,0x51,0xf1,0x50,0x41,0x1a,0x28,0x9f,0x29,0x1b,0xc8,0x18,0xe1,0x0b,0x27,0x1f,0xf2,0x0f,0x1c,0x90,0x52,0xcf,0x64,0x07,0xc0,0xfa,0xbf,0x99
};
	

void rsa_test_verify(unsigned char *pucMdData,
					 unsigned long ulMdlen,
					 unsigned char *pucSig,
					 unsigned long ulSiglen)
{
	EVP_PKEY_CTX *ctx;	
	EVP_PKEY *pkey = rsa_get_pubkey();

	printf("==================rsa_test_verify==============================\r\n");
	printf("-------md data---------\r\n");
	BIO_dump_fp(stdout, pucMdData, ulMdlen);
	printf("----sign data------\r\n");
	BIO_dump_fp(stdout, pucSig, ulSiglen);
	

	ctx = EVP_PKEY_CTX_new(pkey, NULL);
	if (ctx == NULL 
		|| EVP_PKEY_verify_init(ctx) <= 0
		|| EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_PKCS1_PSS_PADDING) <=0
		|| EVP_PKEY_CTX_set_signature_md(ctx, EVP_sha256()) <=0
    	|| EVP_PKEY_CTX_set_rsa_mgf1_md(ctx, EVP_sha256()) <= 0
		|| EVP_PKEY_verify(ctx, pucSig, ulSiglen, pucMdData, ulMdlen) <=0 )
	{
		assert(0);
		return;
	}
	else
	{
		printf("verify success\r\n");
	}
	return;
}

void rsa_test_sign(unsigned char *pucMdData, 
				   unsigned long ulMdLen,
				   unsigned char *pucSig,
				   unsigned long *pulSiglen)
{	
	EVP_PKEY_CTX *ctx;
	EVP_PKEY *pkey = rsa_get_prvkey();

	printf("========================rsa_test_sign===============================\r\n");
	printf("-------md data---------\r\n");
	BIO_dump_fp(stdout, pucMdData, ulMdLen);
	
	ctx = EVP_PKEY_CTX_new(pkey, NULL);	
	if (ctx == NULL 
		|| EVP_PKEY_sign_init(ctx)<=0
		|| EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_PKCS1_PSS_PADDING) <= 0
	    || EVP_PKEY_CTX_set_signature_md(ctx, EVP_sha256()) <=0
		|| EVP_PKEY_CTX_set_rsa_mgf1_md(ctx, EVP_sha256()) <=0
//		|| EVP_PKEY_CTX_set_rsa_pss_saltlen(ctx, 0) <= 0
		|| EVP_PKEY_sign(ctx, pucSig, pulSiglen, pucMdData, ulMdLen) <= 0)
	{	
		assert(0);
	}
	else
	{
		printf("----sign data------\r\n");
		BIO_dump_fp(stdout, pucSig, *pulSiglen);
	}
		
	
	EVP_PKEY_free(pkey);
	EVP_PKEY_CTX_free(ctx);

	return;
}

void rsa_test_sign2_padding(unsigned char *pucMdData, 
								 unsigned long ulMdLen,
								 unsigned char *pucSig,
								 unsigned long *pulSiglen)
{	
	EVP_PKEY_CTX *ctx;
	EVP_PKEY_CTX *ctx2;
	EVP_PKEY *pkey = rsa_get_prvkey();
	unsigned char *pucTmpBuf = malloc(1024);
	int iTmpLen = 1024;
	int iRet = 0;

	printf("========================rsa_test_sign2_padding===============================\r\n");
	printf("-------md data---------\r\n");
	BIO_dump_fp(stdout, pucMdData, ulMdLen);	
	
	ctx = EVP_PKEY_CTX_new(pkey, NULL);	
	
	if (ctx == NULL 
		|| EVP_PKEY_sign_init(ctx) <=0
		|| EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_PKCS1_PSS_PADDING) <= 0
	    || EVP_PKEY_CTX_set_signature_md(ctx, EVP_sha256()) <=0
		|| EVP_PKEY_CTX_set_rsa_mgf1_md(ctx, EVP_sha256()) <=0
//		|| EVP_PKEY_CTX_set_rsa_pss_saltlen(ctx, 0) <=0 
		|| (iRet = rsa_test_padding(ctx, 1, pucMdData, ulMdLen, &iTmpLen, pucTmpBuf)) <=0 )
	{	
		assert(0);
		return ;
	}

	printf("-------after padding data-----\r\n");
	BIO_dump_fp(stdout, pucTmpBuf, iTmpLen);

	ctx2 = EVP_PKEY_CTX_new(pkey, NULL);
	EVP_PKEY_sign_init(ctx2);
	EVP_PKEY_CTX_set_rsa_padding(ctx2, RSA_NO_PADDING);
	iRet = EVP_PKEY_sign(ctx2, pucSig, pulSiglen, pucTmpBuf, iTmpLen);
	if (iRet <=0)
	{
		assert(0);
		return;
	}
	else
	{
		printf("----sign data------\r\n");
		BIO_dump_fp(stdout, pucSig, *pulSiglen);
	}
		
	
	EVP_PKEY_free(pkey);
	EVP_PKEY_CTX_free(ctx);
	EVP_PKEY_CTX_free(ctx2);

	return;
}

void rsa_test_verify2_padding(unsigned char *pucMdData,
					 unsigned long ulMdlen,
					 unsigned char *pucSig,
					 unsigned long ulSiglen)
{
	EVP_PKEY_CTX *ctx;	
	EVP_PKEY_CTX *ctx2;
	EVP_PKEY *pkey = rsa_get_pubkey();
	int iRet = 0;
	unsigned char *pucTmpBuf = malloc(1024);
	int iTmpLen = 1024;
	
	printf("==================rsa_test_verify2_padding==============================\r\n");
	printf("-------md data---------\r\n");
	BIO_dump_fp(stdout, pucMdData, ulMdlen);
	printf("----sign data------\r\n");
	BIO_dump_fp(stdout, pucSig, ulSiglen);
	

	ctx = EVP_PKEY_CTX_new(pkey, NULL);
	if (ctx == NULL 
		|| EVP_PKEY_verify_init(ctx) <= 0
		|| EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_PKCS1_PSS_PADDING) <=0
		|| EVP_PKEY_CTX_set_signature_md(ctx, EVP_sha256()) <=0
    	|| EVP_PKEY_CTX_set_rsa_mgf1_md(ctx, EVP_sha256()) <= 0
		|| (iRet = rsa_test_padding(ctx, 1, pucMdData, ulMdlen, &iTmpLen, pucTmpBuf)) <=0 )
	{
		assert(0);
		return;
	}
	printf("------------after padding data----------\r\n");


	ctx2 = EVP_PKEY_CTX_new(pkey, NULL);
	EVP_PKEY_verify_init(ctx2);
	EVP_PKEY_CTX_set_rsa_padding(ctx2, RSA_NO_PADDING);
	iRet = EVP_PKEY_verify(ctx2, pucSig, ulSiglen, pucTmpBuf, iRet);
	if (iRet <=0)
	{
		assert(0);
		return;
	}
	else
	{
		printf("verify success\r\n");
	}

	free(pucTmpBuf);
	EVP_PKEY_CTX_free(ctx);
	EVP_PKEY_CTX_free(ctx2);
	return;
}



int  main()
{
	unsigned char *sig = OPENSSL_zalloc(1024);
	unsigned long siglen = 1024; 
	unsigned char *cipher = OPENSSL_zalloc(1024);
	unsigned long cipherlen = 1024;
	unsigned char *plain = OPENSSL_zalloc(1024);
	unsigned long plainlen = 1024;
	rsa_test_sign2_padding(g_aucMdData, sizeof(g_aucMdData), sig, &siglen);
	
//	rsa_test_sign(g_aucMdData, sizeof(g_aucMdData), sig, &siglen);
	rsa_test_verify(g_aucMdData, sizeof(g_aucMdData), sig, siglen);

//	rsa_test_encrypt(g_aucEncData_nopad, sizeof(g_aucEncData_nopad), cipher, &cipherlen);
//	rsa_test_decrypt(plain, &plainlen, cipher, cipherlen);

	OPENSSL_free(cipher);
	OPENSSL_free(plain);
	OPENSSL_free(sig);


	return 0;
}

#ifdef __cplusplus
}
#endif
